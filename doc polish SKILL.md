---
name: doc-polish
description: "Review and fix formatting, pagination, and visual polish issues in uploaded documents. Triggers on 'review', 'check', 'polish', 'fix formatting', 'clean up', 'proofread layout', or 'QA' any .docx, .pdf, or .pptx file. Also trigger on orphaned headers, broken page breaks, inconsistent fonts, lost content, widows/orphans, or anything about a document not looking right. Auto-corrects issues and returns a polished version — does not just report problems. Use even if the user only says 'make this look professional' or 'this doc looks off' when a file is attached. AUTO-TRIGGER: Also run automatically on any written deliverable Claude creates as a file — emails, proposals, SOWs, guides, SOPs, LinkedIn posts, reports, briefs, blog posts, articles, or any document. MANDATORY PRE-STEP: Before starting doc-polish, always run ai-check Full Fix on the document content first. Voice-correct, then format-polish."
---

# Doc Polish

Review and auto-correct formatting, pagination, and visual issues in documents so they read smoothly and look professional.

## When This Skill Triggers

Two trigger paths:

1. **User uploads a file** and asks to check, review, polish, or fix its formatting. The goal is always to return a corrected version of the document, not just a list of problems.

2. **Claude creates a written deliverable as a file** — any time Claude produces a .docx, .pdf, .pptx, or other document file for the user (proposals, SOWs, guides, SOPs, LinkedIn posts, reports, briefs, blog posts, articles, emails saved as files, or any other written deliverable), doc-polish runs automatically on the output before delivery. This does not require the user to ask for polish — it is automatic.

For both paths, the ai-check skill runs FIRST (voice-correction), then doc-polish handles formatting.

## Critical Rules — Read Before Doing Anything

These rules override everything else in this skill. Violating them causes the exact problems this skill exists to fix.

### NEVER do these things to PDFs:

1. **NEVER merge multiple PDFs with pypdf if any PDF was generated by reportlab, fpdf, or code.** pypdf merging corrupts embedded fonts and renders pages as garbled text or blank pages. If you need to combine pages, rebuild the entire document as a single reportlab canvas.

2. **NEVER use pypdf to rotate pages** unless you visually verify the result immediately. pypdf rotations frequently flip pages upside down or sideways without warning.

3. **NEVER apply pypdf page transformations (merge, overlay, scale) to programmatic PDFs.** These operations destroy the internal font tables that reportlab uses. The result looks fine in some viewers and completely broken in others.

4. **NEVER assume a PDF edit worked without rendering it to an image and visually inspecting it.** Text extraction says nothing about visual layout. You must pdftoppm the result and look at it.

5. **NEVER stack multiple rounds of pypdf operations.** Each round compounds corruption risk. If the first round didn't work cleanly, stop and rebuild from source.

### The safe approach for PDFs:

- **If the PDF was generated from code** (reportlab, fpdf, wkhtmltopdf, etc.): Fix the source code and regenerate. Do not touch the PDF file itself.
- **If the PDF came from a Word/PowerPoint export**: Fix the source .docx/.pptx and re-export.
- **If no source is available**: Only use pypdf for simple operations (extracting pages, reading text). For visual fixes, use reportlab to build a new PDF from scratch with the correct layout.
- **For any operation**: Render before AND after to images. Compare visually. If anything looks wrong, revert immediately.

### Detecting programmatic PDFs:

Check the PDF metadata:
```python
from pypdf import PdfReader
reader = PdfReader('document.pdf')
producer = reader.metadata.get('/Producer', '')
creator = reader.metadata.get('/Creator', '')
print(f"Producer: {producer}, Creator: {creator}")
# If producer contains "ReportLab" or "fpdf" or similar → programmatic PDF
# Do NOT manipulate with pypdf — fix the source code instead
```

## Workflow

Follow these steps in order for every document polish request.

### Pre-Step — AI Check Integration (MANDATORY)

Doc-polish always runs in one of two modes:

**Mode A — User requests doc-polish directly:**
Before doing anything else, run the `ai-check` skill in Full Fix mode on the document content first. Voice-correct the text, then proceed with formatting polish.

**Mode B — Auto-triggered after AI check completes:**
When ai-check finishes on any file deliverable, doc-polish fires automatically without the user asking. In this mode, the content is already voice-corrected — skip straight to the four-pass formatting review.

In both modes, the rule is the same: **voice first, formatting second, no exceptions.**

Any file Claude produces — proposals, guides, SOPs, reports, emails saved as files, or any other document — must pass through both ai-check and doc-polish before being delivered to the user.

### Step 0 — Pre-Check (MANDATORY for PDFs)

Before doing anything else to a PDF:

1. Render ALL pages to images at 120-200 DPI
2. Visually inspect every page image
3. Note the current state (this is your baseline for comparison)
4. Check if the PDF is programmatic (see metadata check above)
5. If programmatic: your job is to REPORT issues, not manipulate the file. Tell the user what needs to change in the source code.

```bash
# Always render first, inspect visually
pdftoppm -jpeg -r 150 document.pdf baseline_page
# Then look at every baseline_page-XX.jpg
```

### Step 1 — Identify the Document Type

Check the file extension of the uploaded document to determine which processing path to follow.

| Extension | Processing Path | Primary Skill |
|-----------|----------------|---------------|
| .docx | Unpack XML → inspect → fix → repack | `docx` skill |
| .pdf | Render to images → inspect → report OR rebuild from source | `pdf` skill |
| .pptx | Unpack XML → inspect slides → fix → repack | `pptx` skill |

Before doing anything else, read the relevant primary skill's SKILL.md so you have the correct tools, scripts, and XML patterns loaded.

### Step 2 — Extract and Render for Inspection

You need to see the document the way a reader would. This means converting it to a visual format so you can catch layout problems that text extraction alone would miss.

**For .docx files:**
```bash
# Convert to PDF first, then to page images
python scripts/office/soffice.py --headless --convert-to pdf document.docx
pdftoppm -jpeg -r 200 document.pdf page

# Also unpack for XML-level fixes
python scripts/office/unpack.py document.docx unpacked/
```

**For .pdf files:**
```bash
# Render pages as images for visual inspection
pdftoppm -jpeg -r 150 document.pdf page

# Extract text to check content flow
python3 -c "
from pypdf import PdfReader
reader = PdfReader('document.pdf')
for i, page in enumerate(reader.pages):
    print(f'--- PAGE {i+1} ---')
    print(page.extract_text())
"

# Check if programmatic (CRITICAL — determines your fix strategy)
python3 -c "
from pypdf import PdfReader
r = PdfReader('document.pdf')
print('Producer:', r.metadata.get('/Producer', 'unknown'))
print('Creator:', r.metadata.get('/Creator', 'unknown'))
print('Pages:', len(r.pages))
"
```

**For .pptx files:**
```bash
# Generate slide thumbnails
python scripts/thumbnail.py presentation.pptx

# Unpack for XML-level fixes
python scripts/office/unpack.py presentation.pptx unpacked/
```

### Step 3 — Run the Four-Pass Review

Inspect the rendered pages and extracted content using four passes, in priority order. Each pass focuses on one category of issues. Fix issues as you find them — do not just catalog them.

For the detailed checklist of what to look for in each pass, read `references/review-checklist.md`.

**Pass 1 — Pagination** (highest priority)
Look at the rendered page images. The most common problems are headers or subheadings stranded at the bottom of a page with their body text starting on the next page, and single lines of a paragraph isolated at the top or bottom of a page. These are the issues users care about most because they make documents look careless.

**Pass 2 — Formatting Consistency**
Check that the same types of elements look the same throughout the document. Headings at the same level should use the same font, size, and spacing. Body text should use one font and one size. Bullet styles should be uniform. Spacing between sections should be predictable.

**Pass 3 — Visual Polish**
Check alignment, margins, table sizing, and image placement. Tables should not overflow page margins. Images should not overlap text or sit awkwardly between paragraphs. White space should feel intentional, not accidental.

**Specific things to catch in Pass 3:**

- **Excessive white space**: More than 30% of a page is empty below the last content element. Content should be redistributed or the page should be removed.
- **Overlapping text**: Any text element visually overlaps another. Check especially where images meet text, where code blocks sit near body text, and where footers collide with content.
- **Elements bleeding off-page**: Text or shapes extending beyond page margins.
- **Upside-down or rotated content**: Pages where text appears flipped or sideways. This is almost always caused by a bad pypdf rotation — the fix is to regenerate, not rotate again.

**Pass 4 — Content Flow**
Read through the extracted text in order. Flag anything that feels abrupt — a section that ends mid-thought, a transition that jumps topics without warning, or a heading that promises content the section does not deliver. This pass is about readability, not grammar.

### Step 4 — Apply Fixes

How you fix depends on the document type.

**For .docx files** — edit the unpacked XML directly:

Pagination fixes use `<w:pPr>` properties:
```xml
<!-- Keep heading with its next paragraph (prevents orphaned headers) -->
<w:pPr>
  <w:keepNext/>
  <w:keepLines/>
</w:pPr>

<!-- Force a page break before a major section -->
<w:pPr>
  <w:pageBreakBefore/>
</w:pPr>

<!-- Widow/orphan control (keeps at least 2 lines together) -->
<w:pPr>
  <w:widowControl/>
</w:pPr>
```

Formatting consistency fixes involve normalizing `<w:rPr>` (run properties) and `<w:pPr>` (paragraph properties) across similar elements. When you find a heading using a different font or size than other headings at the same level, update its properties to match.

After all XML edits:
```bash
python scripts/office/pack.py unpacked/ output.docx --original document.docx
python scripts/office/validate.py output.docx
```

**For .pdf files** — Choose the right strategy:

| Situation | Strategy |
|-----------|----------|
| PDF was generated from code (reportlab, etc.) | Fix the Python/code source. Regenerate the PDF. Do NOT touch the PDF. |
| PDF was exported from .docx/.pptx | Fix the source file. Re-export. |
| PDF is from an unknown source, minor issues | Use reportlab to create overlay corrections only. Do not merge or transform pages. |
| PDF is from an unknown source, major issues | Rebuild the entire PDF from scratch using reportlab. Extract text content first, then lay it out fresh. |
| PDF needs pages reordered | pypdf page extraction to individual files, then rebuild as single reportlab canvas. Do NOT use PdfMerger. |

**CRITICAL: Never use `PdfMerger` or `PdfWriter.add_page()` on programmatic PDFs. This is the #1 cause of corrupted output.**

**For .pptx files** — edit the unpacked XML:

Common fixes include adjusting text box positions (in slide XML `<a:off>` and `<a:ext>` attributes), normalizing font sizes across slides, and ensuring consistent slide layouts. After edits:
```bash
python scripts/office/pack.py unpacked/ output.pptx --original presentation.pptx
```

### Step 5 — Verify and Deliver (MANDATORY — no exceptions)

After applying fixes, you MUST render the corrected document to images and visually confirm every page looks correct. This is not optional. Skipping this step is how broken documents get delivered.

```bash
# Re-render the fixed document
pdftoppm -jpeg -r 150 output.pdf fixed_page

# Compare: look at EVERY fixed_page image
# Check specifically for:
# 1. Text still readable (not garbled/corrupted)
# 2. No pages upside down or rotated
# 3. No overlapping elements
# 4. No excessive white space
# 5. All content from original still present
```

**If ANY page looks wrong after your fix:**
1. STOP immediately
2. Do NOT deliver the broken file
3. Revert to the original
4. Try a different fix strategy (usually: rebuild from source instead of manipulating the PDF)

Present the fixed document to the user. Briefly summarize what you fixed — keep it to 2-3 sentences covering the most impactful changes. Do not write a lengthy report unless the user asks for one.

## Edge Cases

**Document is a scan or image-based PDF.** You cannot fix formatting in a rasterized document. Let the user know and offer to OCR it and recreate it as a clean .docx instead.

**Document uses a custom template with embedded styles.** Be careful not to strip or override template styles that are intentional. When in doubt, preserve the original style and only fix clear inconsistencies (like a single heading that differs from all others at the same level).

**Document is password-protected.** Ask the user for the password before proceeding.

**Very large documents (50+ pages).** Work in sections. Process 10-15 pages at a time to keep rendering manageable and avoid missing issues in the middle of the document.

**PDF was generated by reportlab or similar code generator.** This is extremely common in this project. These PDFs CANNOT be safely manipulated with pypdf. The only fix is to modify the source code and regenerate. If you don't have access to the source code, report the issues and explain that a source-level fix is needed.

## Common Mistakes This Skill Must Prevent

These are real problems that have occurred repeatedly. The skill exists partly to prevent them from happening again.

1. **Using pypdf to merge reportlab PDFs** → Fonts corrupt, text becomes unreadable
2. **Using PDF alpha layers for gradients** → Visible banding lines across images. Use PIL to pre-bake gradients into images instead.
3. **Stacking multiple pypdf operations** → Each round compounds corruption. After 2+ rounds, the PDF is usually unrecoverable.
4. **Not rendering after edits** → Delivering a broken PDF because text extraction looked fine but visual rendering was destroyed.
5. **Rotating pages with pypdf** → Pages end up upside down. Always verify visually.
6. **Assuming white space is intentional** → If more than 30% of a page is empty below content, it needs to be addressed.
7. **Not checking for overlapping elements** → Text on top of other text, images covering content.

## What This Skill Does NOT Do

This skill focuses on layout and formatting. It does not perform grammar checking, spell checking, or content rewriting. If the user needs those services, suggest pairing this skill with a content editing pass after the formatting is fixed — fix the container first, then the contents.

## Resources

### references/
- `review-checklist.md` — Detailed checklist for each of the four review passes, organized by document type
